<!doctype html>
<html lang="ar">
<head>
    <meta charset="utf-8">
    <title>FINAL FIX - IVASMS</title>
    <style>
        body{background:#0d1117;color:#c9d1d9;font-family:sans-serif;text-align:center;padding:20px}
        .card{background:#161b22;border:1px solid #30363d;padding:20px;border-radius:10px}
        #log{text-align:left;background:#000;padding:10px;margin-top:20px;height:200px;overflow:auto;font-size:11px}
        button{background:#238636;color:white;border:0;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:bold}
    </style>
</head>
<body>
    <div class="card">
        <h2>IVASMS Monitor - Ultimate Fix</h2>
        <p id="st">Status: Ready</p>
        <button onclick="start()">START MONITORING</button>
        <div id="log"></div>
    </div>

<script>
const BOT_TOKEN = '8109361019:AAFnrD44Yek8qlvBvWvGDLWBWtpOCAOp8yc';
const CHAT_ID = '-1003005165528';
let seen = new Set();

async function sendTele(text) {
    try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: CHAT_ID, text: text})
        });
    } catch(e) {}
}

async function check() {
    document.getElementById('st').innerText = "Scanning...";
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙˆÙƒØ³ÙŠ "cors-anywhere" Ø§Ù„Ø¹Ø§Ù… ÙƒØ¨Ø¯ÙŠÙ„ Ø£Ø®ÙŠØ±
    const proxyUrl = "https://cors-anywhere.herokuapp.com/";
    const targetUrl = "https://ivasms.com/portal";
    
    try {
        const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(targetUrl));
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        const rows = doc.querySelectorAll("tr");

        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            if (cells.length >= 2) {
                const phone = cells[0].innerText.trim();
                const code = cells[cells.length - 1].innerText.trim();
                const service = cells[1].innerText.trim();

                if (code && code.length > 1) {
                    const id = phone + code;
                    if (!seen.has(id)) {
                        seen.add(id);
                        sendTele(`ðŸš€ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯!\nØ§Ù„Ø®Ø¯Ù…Ø©: ${service}\nØ§Ù„Ø±Ù‚Ù…: ${phone}\nØ§Ù„ÙƒÙˆØ¯: ${code}`);
                        const item = document.createElement('div');
                        item.innerHTML = `<span style="color:#4ade80">âœ… Sent: ${phone}</span>`;
                        document.getElementById('log').prepend(item);
                    }
                }
            }
        });
        document.getElementById('st').innerText = "Waiting...";
    } catch (e) {
        document.getElementById('st').innerText = "Retry in 10s...";
    }
}

function start() {
    setInterval(check, 10000);
    check();
}
</script>
</body>
</html>
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const rows = doc.querySelectorAll("tr");

        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            if (cells.length > 3) {
                const phone = cells[0].innerText.trim();
                const service = cells[1].innerText.trim();
                const code = cells[cells.length - 1].innerText.trim();
                
                if (code && code.length > 1) {
                    const id = phone + code;
                    if (!seen.has(id)) {
                        seen.add(id);
                        send(`âœ… ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯!\nØ§Ù„Ø®Ø¯Ù…Ø©: ${service}\nØ§Ù„Ø±Ù‚Ù…: ${phone}\nØ§Ù„ÙƒÙˆØ¯: ${code}`);
                        const div = document.createElement('div');
                        div.innerHTML = `<span class="green">Sent: ${phone} - ${code}</span>`;
                        document.getElementById('log').prepend(div);
                    }
                }
            }
        });
        document.getElementById('st').innerHTML = "Waiting for new codes...";
    } catch (e) {
        document.getElementById('st').innerHTML = "<span class='red'>Connection Error - Retrying...</span>";
    }
}

function start() {
    setInterval(check, 10000);
    check();
}
</script>
</body>
</html>
        
        let foundNew = false;
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 2) {
            const phone = cells[0].innerText.trim();
            const service = cells[1].innerText.trim();
            const code = cells[cells.length-1].innerText.trim();
            
            if (phone && code && code.length > 1) {
              const id = phone + code;
              if (!sentIds.has(id)) {
                sentIds.add(id);
                sendTelegram(phone, code, service);
                log(`âœ… Sent: ${phone} - ${code} (${service})`);
                foundNew = true;
              }
            }
          }
        });
        if(!foundNew) document.getElementById('statusText').textContent = 'No new codes';
      } catch (e) {
        log("âŒ Error fetching data - Retrying...", true);
      }
      setTimeout(scan, 10000); // ÙŠÙØ­Øµ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
    }

    document.getElementById('startBtn').onclick = () => {
      if(!running) { running = true; log("ðŸš€ Monitor Started"); scan(); }
    };
    document.getElementById('stopBtn').onclick = () => {
      running = false; log("ðŸ›‘ Monitor Stopped");
      document.getElementById('statusText').textContent = 'Stopped';
    };
  })();
  </script>
</body>
</html>
