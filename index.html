<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IVASMS Monitor â€” Fix Active</title>
  <style>
    :root{font-family:system-ui,Segoe UI,Roboto;line-height:1.4}
    body{margin:0;padding:16px;background:#0f1720;color:#e6eef8}
    .card{background:#0b1220;border-radius:10px;padding:16px;box-shadow:0 4px 18px rgba(2,6,23,.6)}
    h1{margin:0 0 8px;font-size:18px;color:#7dd3fc}
    .controls{display:flex;gap:8px;margin-bottom:15px}
    button{border:0;padding:10px 14px;border-radius:8px;background:#1f6feb;color:white;font-weight:600;cursor:pointer}
    #status{margin-top:10px;font-size:12px;color:#9fb2cc}
    .list{margin-top:12px;max-height:300px;overflow:auto;background:#07111a;border-radius:8px;padding:10px}
    .item{padding:8px;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}
    .success{color:#4ade80}
    .error{color:#f87171}
  </style>
</head>
<body>
  <div class="card">
    <h1>IVASMS Monitor (Fix 2026)</h1>
    <div class="controls">
      <button id="startBtn">Start Now</button>
      <button id="stopBtn" style="background:#334155">Stop</button>
    </div>
    <div id="status">Status: <span id="statusText" class="success">Ready</span></div>
    <div class="list" id="log"></div>
  </div>

  <script>
  (function () {
    const TARGET_URL = 'https://ivasms.com/portal';
    const TELEGRAM_BOT_TOKEN = '8109361019:AAFnrD44Yek8qlvBvWvGDLWBWtpOCAOp8yc';
    const TELEGRAM_CHAT_ID = '-1003005165528';

    // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø±ÙˆÙƒØ³ÙŠØ§Øª Ù…Ø­Ø¯Ø«Ø© Ù„ØªØ¬Ø§ÙˆØ² CORS
    const CORS_PROXIES = [
      'https://api.allorigins.win/raw?url={url}',
      'https://corsproxy.io/?{url}',
      'https://thingproxy.freeboard.io/fetch/{url}'
    ];

    let running = false;
    let sentIds = new Set();
    const logEl = document.getElementById('log');

    function log(msg, isError = false) {
      const div = document.createElement('div');
      div.className = 'item' + (isError ? ' error' : '');
      div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.prepend(div);
    }

    async function fetchWithFallback() {
      for (let proxy of CORS_PROXIES) {
        try {
          const url = proxy.replace('{url}', encodeURIComponent(TARGET_URL));
          const res = await fetch(url);
          if (res.ok) return await res.text();
        } catch (e) {}
      }
      throw new Error("All proxies failed");
    }

    async function sendTelegram(phone, code, service) {
      const text = `ðŸ“¬ New Code Found!\nðŸ“± Phone: ${phone}\nðŸ”‘ Code: ${code}\nðŸ›  Service: ${service}`;
      try {
        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({chat_id: TELEGRAM_CHAT_ID, text: text})
        });
        return true;
      } catch (e) { return false; }
    }

    async function scan() {
      if (!running) return;
      document.getElementById('statusText').textContent = 'Scanning...';
      try {
        const html = await fetchWithFallback();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const rows = doc.querySelectorAll('tr');
        
        let foundNew = false;
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 2) {
            const phone = cells[0].innerText.trim();
            const service = cells[1].innerText.trim();
            const code = cells[cells.length-1].innerText.trim();
            
            if (phone && code && code.length > 1) {
              const id = phone + code;
              if (!sentIds.has(id)) {
                sentIds.add(id);
                sendTelegram(phone, code, service);
                log(`âœ… Sent: ${phone} - ${code} (${service})`);
                foundNew = true;
              }
            }
          }
        });
        if(!foundNew) document.getElementById('statusText').textContent = 'No new codes';
      } catch (e) {
        log("âŒ Error fetching data - Retrying...", true);
      }
      setTimeout(scan, 10000); // ÙŠÙØ­Øµ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
    }

    document.getElementById('startBtn').onclick = () => {
      if(!running) { running = true; log("ðŸš€ Monitor Started"); scan(); }
    };
    document.getElementById('stopBtn').onclick = () => {
      running = false; log("ðŸ›‘ Monitor Stopped");
      document.getElementById('statusText').textContent = 'Stopped';
    };
  })();
  </script>
</body>
</html>
